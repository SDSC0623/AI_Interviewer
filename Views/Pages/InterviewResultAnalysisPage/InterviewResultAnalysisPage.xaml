<Page x:Class="AI_Interviewer.Views.Pages.InterviewResultAnalysisPage.InterviewResultAnalysisPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
      xmlns:local="clr-namespace:AI_Interviewer.Views.Pages.InterviewResultAnalysisPage"
      xmlns:interviewResultAnalysisPage="clr-namespace:AI_Interviewer.ViewModels.InterviewResultAnalysisPage"
      xmlns:converters="clr-namespace:AI_Interviewer.Converters"
      xmlns:behaviors="clr-namespace:AI_Interviewer.Behaviors"
      mc:Ignorable="d"
      d:DesignHeight="1800"
      d:DesignWidth="1000"
      ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
      ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
      d:DataContext="{d:DesignInstance Type=interviewResultAnalysisPage:InterviewResultAnalysisViewModel}"
      Title="InterviewResultAnalysisPage">
    <Page.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:EnumDescriptionConverter x:Key="EnumDescriptionConverter" />
    </Page.Resources>
    <Grid>
        <ui:DynamicScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <!-- 顶部标题栏 -->
                <Grid Grid.Row="0" Margin="0,0,0,30">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- 页面标题 -->
                    <ui:SymbolIcon Grid.Column="0" Symbol="AppsList24"
                                   Filled="True"
                                   FontSize="24"
                                   Margin="0,0,12,0"
                                   Foreground="#2196F3" />
                    <ui:TextBlock Grid.Column="1" Text="面试结果分析"
                                  FontTypography="Title"
                                  FontSize="24"
                                  FontWeight="Bold" />
                    <ui:Button Grid.Column="2" Icon="{ui:SymbolIcon ArrowSync24, Filled=True, FontSize=22}"
                               Command="{Binding RefreshInterviewAnswerCommand}"/>
                </Grid>
                <Grid Grid.Row="1">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="20" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- 左侧：历史面试记录 -->
                    <ui:Border Grid.Column="0"
                               CornerRadius="12"
                               Background="{DynamicResource ControlFillColorDefaultBrush}"
                               BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                               BorderThickness="1"
                               Padding="16">
                        <StackPanel>
                            <!-- 标题 -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                <ui:SymbolIcon Symbol="History24"
                                               FontSize="20"
                                               Foreground="#2196F3"
                                               Margin="0,0,8,0" />
                                <ui:TextBlock Text="历史面试记录"
                                              FontTypography="Subtitle"
                                              FontSize="18"
                                              FontWeight="SemiBold" />
                            </StackPanel>

                            <!-- 列表 -->
                            <ItemsControl ItemsSource="{Binding InterviewHistorys}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <ui:Border x:Name="Card"
                                                   CornerRadius="8"
                                                   Padding="12"
                                                   Margin="0,0,0,10"
                                                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                                   BorderThickness="1"
                                                   Background="{DynamicResource LayerOnAcrylicFillColorDefaultBrush}"
                                                   Cursor="Hand">
                                            <i:Interaction.Behaviors>
                                                <behaviors:SelectInterviewBehavior
                                                    HoverBackgroundBrush="{DynamicResource TextFillColorDisabledBrush}"
                                                    SelectedBackgroundBrush="{DynamicResource ControlFillColorSecondaryBrush}"
                                                    NormalBackgroundBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                                    SelectedInterview="{Binding DataContext.SelectedInterview, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:InterviewResultAnalysisPage}}}"
                                                    MouseLeftClickCommand="{Binding DataContext.SelectInterviewCommand, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type local:InterviewResultAnalysisPage}}}"
                                                    CommandParameter="{Binding}"
                                                    Self="{Binding}" />
                                            </i:Interaction.Behaviors>
                                            <StackPanel>
                                                <!-- 时间 -->
                                                <ui:TextBlock
                                                    Text="{Binding Time, StringFormat=面试时间：{0:yyyy-MM-dd HH:mm}}"
                                                    FontTypography="Body"
                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                    Margin="0,0,0,4" />

                                                <!-- 岗位 -->
                                                <ui:TextBlock
                                                    Text="{Binding Resume.JobIntention.TargetPosition, StringFormat=面试岗位：{0}}"
                                                    FontTypography="BodyStrong"
                                                    Margin="0,0,0,4" />

                                                <!-- 题目数量 -->
                                                <ui:TextBlock
                                                    Text="{Binding QAndA.Count, StringFormat=题目数量：{0}}"
                                                    FontTypography="Body"
                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                            </StackPanel>
                                        </ui:Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ui:Border>

                    <!-- 右侧：面试详情 -->
                    <Grid Grid.Column="2">
                        <!-- 未选择提示 -->
                        <ui:Border Background="{DynamicResource ControlFillColorDefaultBrush}"
                                   BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                   BorderThickness="1"
                                   Visibility="{Binding HasSelectedInterview, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=True}">
                            <StackPanel HorizontalAlignment="Center"
                                        VerticalAlignment="Center">
                                <ui:SymbolIcon Symbol="DocumentSearch24"
                                               FontSize="48"
                                               Foreground="{DynamicResource TextFillColorTertiaryBrush}"
                                               Margin="0,0,0,12" />
                                <ui:TextBlock Text="请选择左侧一条面试记录查看详情"
                                              FontSize="16"
                                              Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            </StackPanel>
                        </ui:Border>

                        <!-- 已选择 -->
                        <ui:DynamicScrollViewer Padding="20">
                            <StackPanel
                                Visibility="{Binding HasSelectedInterview, Converter={StaticResource BooleanToVisibilityConverter}}">

                                <!-- 标题 -->
                                <ui:TextBlock
                                    Text="{Binding SelectedInterview.Resume.JobIntention.TargetPosition, StringFormat={}{0} 面试报告}"
                                    FontSize="24"
                                    FontWeight="Bold"
                                    Margin="0,0,0,8" />

                                <!-- 时间 + 题目数 -->
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
                                    <ui:TextBlock
                                        Text="{Binding SelectedInterview.Time, StringFormat={}{0:yyyy年MM月dd日 HH:mm}}"
                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                    <ui:TextBlock Text=" · " Margin="6,0" />
                                    <ui:TextBlock
                                        Text="{Binding SelectedInterview.QAndA.Count, StringFormat=共 {0} 题}"
                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                </StackPanel>

                                <!-- 分析报告按钮 -->
                                <ui:Button Appearance="Primary"
                                           Padding="16,8"
                                           Margin="0,0,0,24"
                                           HorizontalAlignment="Left"
                                           Content="生成分析报告（AI）" />

                                <!-- 问答详情 -->
                                <ItemsControl ItemsSource="{Binding SelectedInterview.QAndA}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <ui:Border CornerRadius="8"
                                                       BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                                       BorderThickness="1"
                                                       Background="{DynamicResource ControlFillColorDefaultBrush}"
                                                       Padding="20"
                                                       Margin="0,0,0,16">
                                                <StackPanel>

                                                    <ui:TextBlock Text="{Binding QuestionText}"
                                                                  FontSize="16"
                                                                  FontWeight="SemiBold"
                                                                  TextWrapping="Wrap"
                                                                  Margin="0,0,0,8" />

                                                    <ui:TextBlock
                                                        Text="{Binding Difficulty, Converter={StaticResource EnumDescriptionConverter}}"
                                                        FontSize="12"
                                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                        Margin="0,0,0,12" />

                                                    <ui:TextBlock Text="回答："
                                                                  FontTypography="Caption"
                                                                  Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                                                  Margin="0,0,0,4" />

                                                    <ui:TextBlock Text="{Binding CustomAnswer}"
                                                                  FontSize="14"
                                                                  TextWrapping="Wrap" />
                                                </StackPanel>
                                            </ui:Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </ui:DynamicScrollViewer>
                    </Grid>
                </Grid>
            </Grid>
        </ui:DynamicScrollViewer>
    </Grid>
</Page>